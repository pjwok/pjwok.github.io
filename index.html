
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>录音2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- import Vue.js -->
<script src="//unpkg.com/vue@2.6.14/dist/vue.min.js"></script>
<!-- import stylesheet -->
<link rel="stylesheet" href="//unpkg.com/view-design/dist/styles/iview.css">
<!-- import iView -->
<script src="//unpkg.com/view-design/dist/iview.min.js"></script>
<script src="./recorder.js"></script>
    
  </head>
  <body>
    <div id="app">
        <kabala-audio-recorder @on-stop="onStop" @on-start="onStart"></kabala-audio-recorder>
    </div>
    <hr>

    <script>
        Vue.component('kabala-audio-recorder',{
            name:'kabala-audio-recorder',
            template:"" +
                "<div>" +
                "    <slot>" +
                "        <i-button v-if='!isRecording' @click='startRecording()'><Icon type=\"md-radio-button-off\" size='24'></Icon></i-button>" +
                "        <i-button v-else @click='stopRecording()' type='primary' ghost><Icon type=\"md-radio-button-on\" size='24'></Icon></i-button>" +
              " <audio controls class=\"audio-player\"></audio>"+
                "    </slot>" +
                "</div>" +
                "",
            data:function(){
                return {
                    rec:null,
                    gumStream:null,
                    isRecording:false,
                }
            },
            methods:{
                // 开始录音
                startRecording:function() {
                    let that = this;
                    if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
                        var constraints = { audio: true, video:false }
                        navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
                            try{
                                that.isRecording = true;
                                that.gumStream = stream;

                                let audioContext = new AudioContext();
                                let input = audioContext.createMediaStreamSource(stream);

                                that.rec = new Recorder(input,{
                                    numChannels:1,
                                    type:"wav",
                                    bitRate:128,
                                    sampleRate:16000,
                                    // bufferSize:8192,
                                })

                                navigator.vibrate = navigator.vibrate || navigator.webkitVibrate || navigator.mozVibrate || navigator.msVibrate;
                                if(navigator.vibrate) {
                                    console.info("支持设备震动！");
                                    navigator.vibrate(1000);
                                } else {
                                    console.log("不支持设备震动！");
                                }

                                that.rec.record();
                                that.$emit('on-start',that);
                                alert("开始录音");
                            }catch(e){
                                alert(e.toString())
                            }
                            
                        }).catch(function(e) {
                            console.error(e);
                            alert(e.toString());
                            that.isRecording = false;

                        });
                    } else {
                        alert('当前环境不支持录音');
                    }
                },
                // 结束录音
                stopRecording:function() {
                    alert("结束录音");
                    // if(this.isRecording){
                        this.rec.stop();
                        this.gumStream.getAudioTracks()[0].stop();

                        this.rec.exportWAV(this.convertBase64);
                    // }
                },
                convertBase64:function(blob) {
                    alert('转换')
                    let that = this;
                    let reader = new FileReader();
                    reader.onload = function(event) {
                        let base64String = event.target.result;
                        alert('base64String=='+base64String);
                        console.log(base64String)
                        that.$emit('on-stop', base64String);
                        that.isRecording = false;
                    };
                    reader.readAsDataURL(blob);

try{
                        var audioURL = window.URL.createObjectURL(blob);
                        let audio = document.querySelector('.audio-player');
                        audio.src = audioURL;
                    }catch(e){
                        console.error(e);
                    }
                  
                }
            },
            created:function(){

            }
        });
    new Vue({
        el:"#app",
        data:{
        },
        methods:{
            onStart:function(){
                alert('start')
            },
            onStop:function(base64Str){
                alert(base64Str)
            }
        }
    })
    </script>

  </body>
</html>
